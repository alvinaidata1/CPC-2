name: WINDOWS RDP with Bore TCP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest

    steps:
      - name: Enhanced RDP Configuration
        run: |
          Write-Output "Configuring RDP with enhanced settings..."

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fAllowSecProtocolNegotiation" -Value 0 -Force

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Remove-NetFirewallRule -DisplayName "RDP-Custom" -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "RDP-Custom" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow

          Set-Service -Name "TermService" -StartupType Automatic
          Start-Service -Name "TermService"

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "TSEnabled" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "TSUserEnabled" -Value 1 -Force

          Write-Output "✅ RDP configuration completed"

      - name: Allow Simple Passwords
        run: |
          secedit /export /cfg secpol.cfg
          (Get-Content secpol.cfg).Replace("PasswordComplexity = 1", "PasswordComplexity = 0") | Set-Content secpol.cfg
          secedit /configure /db secpol.sdb /cfg secpol.cfg /areas SECURITYPOLICY

      - name: Create RDP User
        run: |
          $username = "${{ secrets.NAME }}"
          $password = "${{ secrets.PASS }}"
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username -Force
          }

          New-LocalUser -Name $username -Password $securePassword -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

          Write-Output "✅ User created"

      - name: Download and Start Bore TCP Tunnel
        shell: pwsh
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.6.0/bore-v0.6.0-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath . -Force

          Start-Process .\bore.exe -ArgumentList "local","3389","--to","bore.pub" -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Keep Services Running (6 hours)
        run: |
          Write-Output "⏱️ Keeping workflow alive for 6 hours"

          for ($i = 0; $i -lt 2160; $i++) {
            Start-Sleep -Seconds 10

            if ((Get-Service TermService).Status -ne "Running") {
              Start-Service TermService
            }

            if (-not (Get-Process bore -ErrorAction SilentlyContinue)) {
              Start-Process .\bore.exe -ArgumentList "local","3389","--to","bore.pub" -NoNewWindow
            }
          }
