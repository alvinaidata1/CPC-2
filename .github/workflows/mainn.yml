name: RDP1

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Force-enable RDP (max compatibility)
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f

          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v fEnableWinStation /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v AuthenticationLevel /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v MinEncryptionLevel /t REG_DWORD /d 1 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d 3389 /f

          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fClientDisableUDP /t REG_DWORD /d 1 /f

          netsh advfirewall firewall add rule name="RDP-ngrok" dir=in action=allow protocol=TCP localport=3389

          Restart-Service TermService -Force

      - name: Create RDP user
        run: |
          $u = "${{ secrets.NAME }}"
          $p = "${{ secrets.PASS }}"

          secedit /export /cfg $env:TEMP\secpol.cfg
          (Get-Content $env:TEMP\secpol.cfg).Replace("PasswordComplexity = 1","PasswordComplexity = 0") | Set-Content $env:TEMP\secpol.cfg
          secedit /configure /db secedit.sdb /cfg $env:TEMP\secpol.cfg /areas SECURITYPOLICY
          gpupdate /force

          $sp = ConvertTo-SecureString $p -AsPlainText -Force

          if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sp -AccountNeverExpires
          }

          Add-LocalGroupMember Administrators $u
          Add-LocalGroupMember "Remote Desktop Users" $u

          echo "RDP_USER=$u" >> $env:GITHUB_ENV
          echo "RDP_PASS=$p" >> $env:GITHUB_ENV

      - name: Download ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip ngrok

      - name: Configure ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN

      - name: Start ngrok TCP tunnel
        run: |
          Start-Process -NoNewWindow `
            -FilePath ".\ngrok\ngrok.exe" `
            -ArgumentList "tcp 3389 --log=stdout --log-format=json" `
            -RedirectStandardOutput ngrok.log
          Start-Sleep -Seconds 20

      - name: Extract ngrok address
        run: |
          $line = Get-Content ngrok.log | Select-String '"url":"tcp://'
          $addr = ($line -split '"url":"')[1].Split('"')[0].Replace("tcp://","")
          echo "NGROK_ADDR=$addr" >> $env:GITHUB_ENV

      - name: Keep alive
        run: |
          Write-Host ""
          Write-Host "====== RDP READY ======"
          Write-Host "Address  : $env:NGROK_ADDR"
          Write-Host "Username : .\$env:RDP_USER"
          Write-Host "Password : $env:RDP_PASS"
          Write-Host "======================="
          Write-Host ""

          while ($true) {
            Start-Sleep 300
          }
